{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "omsLogAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Create new or use an existing Log Analytic Workspace"
      }
    },
    "omsLogAnalyticsRegion": {
      "type": "string",
      "allowedValues": [
        "westeurope",
        "eastus",
        "southeastasia",
        "australiasoutheast",
        "wescentralus"
      ],
      "metadata": {
        "description": "Specify the Azure Region for your new or existing OMS workspace"
      }
    },
    "omsLogAnalyticsSku": {
      "type": "string",
      "defaultValue": "free",
      "allowedValues": [
        "free",
        "standalone",
        "pernode"
      ],
      "metadata": {
        "description": "Specify the SKU for Log Analytics"
      }
    },
    "omsAutomationAccountName": {
      "type": "string",
      "metadata": {
        "description": "Use an existing Automation account or create a new"
      }
    },
    "omsAutomationRegion": {
      "type": "string",
      "allowedValues": [
        "westeurope",
        "southeastasia",
        "eastus2",
        "southcentralus",
        "japaneast",
        "southeastasia",
        "southcentralus",
        "northeurope",
        "canadacentral",
        "australiasoutheast",
        "centralindia",
        "japaneast"
      ],
      "metadata": {
        "description": "Specify the Azure Region for your OMS Automation Account"
      }
    },
    "omsDataIngestionFrequency": {
      "type": "string",
      "defaultValue": "Hourly",
      "allowedValues": [
        "Hourly",
        "Daily"
      ],
      "metadata": {
        "description": "Specify the Azure Usage data retrieval frequency"
      }
    },
    "Currency": {
      "type": "string",
      "defaultValue": "USD",
      "allowedValues": [
        "ARS",
        "AUD",
        "BRL",
        "CAD",
        "CHF",
        "DKK",
        "EUR",
        "GBP",
        "HKD",
        "IDR",
        "INR",
        "JPY",
        "KRW",
        "MXN",
        "MYR",
        "NOK",
        "NZD",
        "RUB",
        "SAR",
        "SEK",
        "TRY",
        "TWD",
        "USD",
        "ZAR"
      ],
      "metadata": {
        "description": "Specify the Azure Billing Currency"
      }
    },
    "RegionInfo": {
      "type": "string",
      "defaultValue": "United States",
      "allowedValues": [
        "Afghanistan",
        "Albania",
        "Algeria",
        "Angola",
        "Argentina",
        "Armenia",
        "Australia",
        "Austria",
        "Azerbaijan",
        "Bahamas",
        "Bahrain",
        "Bangladesh",
        "Barbados",
        "Belarus",
        "Belgium",
        "Belize",
        "Bermuda",
        "Bolivia",
        "Bosnia and Herzegovina",
        "Botswana",
        "Brazil",
        "Brunei",
        "Bulgaria",
        "Cameroon",
        "Canada",
        "Cape Verde",
        "Cayman Islands",
        "Chile",
        "Colombia",
        "Costa Rica",
        "Côte d’Ivoire",
        "Croatia",
        "Curaçao",
        "Cyprus",
        "Czech Republic",
        "Denmark",
        "Dominican Republic",
        "Ecuador",
        "Egypt",
        "El Salvador",
        "Estonia",
        "Ethiopia",
        "Faroe Islands",
        "Fiji",
        "Finland",
        "France",
        "Georgia",
        "Germany",
        "Ghana",
        "Greece",
        "Guatemala",
        "Honduras",
        "Hong Kong SAR",
        "Hungary",
        "Iceland",
        "India",
        "Indonesia",
        "Iraq",
        "Ireland",
        "Israel",
        "Italy",
        "Jamaica",
        "Japan",
        "Jordan",
        "Kazakhstan",
        "Kenya",
        "Korea",
        "Kuwait",
        "Kyrgyzstan",
        "Latvia",
        "Lebanon",
        "Libya",
        "Liechtenstein",
        "Lithuania",
        "Luxembourg",
        "Macao SAR",
        "Macedonia, FYRO",
        "Malaysia",
        "Malta",
        "Mauritius",
        "Mexico",
        "Moldova",
        "Monaco",
        "Mongolia",
        "Montenegro",
        "Morocco",
        "Namibia",
        "Nepal",
        "Netherlands",
        "New Zealand",
        "Nicaragua",
        "Nigeria",
        "Norway",
        "Oman",
        "Pakistan",
        "Palestinian Territory",
        "Panama",
        "Paraguay",
        "Peru",
        "Philippines",
        "Poland",
        "Portugal",
        "Puerto Rico",
        "Qatar",
        "Romania",
        "Russia",
        "Rwanda",
        "Saint Kitts and Nevis",
        "Saudi Arabia",
        "Senegal",
        "Serbia",
        "Singapore",
        "Slovakia",
        "Slovenia",
        "South Africa",
        "Spain",
        "Sri Lanka",
        "Sweden",
        "Switzerland",
        "Taiwan",
        "Tajikistan",
        "Tanzania",
        "Thailand",
        "Trinidad and Tobago",
        "Tunisia",
        "Turkey",
        "Turkmenistan",
        "U.S. Virgin Islands",
        "Uganda",
        "Ukraine",
        "United Arab Emirates",
        "United Kingdom",
        "United States",
        "Uruguay",
        "Uzbekistan",
        "Venezuela",
        "Vietnam",
        "Yemen",
        "Zambia",
        "Zimbabwe"
      ],
      "metadata": {
        "description": "Specify region for Azure BillingSee https://github.com/Azure/azure-content-nlnl/blob/master/articles/billing-countries-and-currencies.md for details."
      }
    },
    "Locale": {
      "type": "string",
      "defaultValue": "en-US",
      "allowedValues": [
        "en-AU",
        "ar-AE",
        "ar-BH",
        "ar-DZ",
        "ar-IQ",
        "ar-JO",
        "ar-KW",
        "ar-LB",
        "ar-LY",
        "ar-MA",
        "ar-OM",
        "ar-QA",
        "ar-SA",
        "ar-TN",
        "ar-YE",
        "bg-BG",
        "ca-ES",
        "cs-CZ",
        "da-DK",
        "de-AT",
        "de-CH",
        "de-DE",
        "de-LI",
        "de-LU",
        "el-CY",
        "el-GR",
        "en-AE",
        "en-BZ",
        "en-CA",
        "en-DZ",
        "en-GB",
        "en-HK",
        "en-IE",
        "en-IN",
        "en-JM",
        "en-JO",
        "en-KE",
        "en-MT",
        "en-MY",
        "en-NG",
        "en-NZ",
        "en-PH",
        "en-SG",
        "en-SI",
        "en-SK",
        "en-TH",
        "en-TT",
        "en-US",
        "en-ZA",
        "en-ZW",
        "es-AR",
        "es-BO",
        "es-CL",
        "es-CO",
        "es-CR",
        "es-DO",
        "es-EC",
        "es-ES",
        "es-GT",
        "es-HN",
        "es-MX",
        "es-NI",
        "es-PA",
        "es-PE",
        "es-PR",
        "es-PY",
        "es-SV",
        "es-US",
        "es-UY",
        "es-VE",
        "et-EE",
        "eu-ES",
        "fi-FI",
        "fr-BE",
        "fr-CA",
        "fr-CH",
        "fr-DZ",
        "fr-FR",
        "fr-LU",
        "fr-MA",
        "fr-MC",
        "fr-SN",
        "fr-TN",
        "gl-ES",
        "he-IL",
        "hi-IN",
        "hr-HR",
        "hu-HU",
        "id-ID",
        "it-CH",
        "it-IT",
        "ja-JP",
        "kk-KZ",
        "ko-KR",
        "lt-LT",
        "lv-LV",
        "ms-BN",
        "ms-MY",
        "nb-NO",
        "nl-BE",
        "nl-NL",
        "pl-PL",
        "pt-BR",
        "pt-PT",
        "ro-RO",
        "ru-BY",
        "ru-KZ",
        "ru-RU",
        "ru-UA",
        "sk-SK",
        "sl-SI",
        "sr-Cyrl-RS",
        "sr-Latn-ME",
        "sr-Latn-RS",
        "sv-FI",
        "sv-SE",
        "th-TH",
        "tr-TR",
        "uk-UA",
        "vi-VN",
        "zh-CN",
        "zh-HK",
        "zh-MO",
        "zh-SG",
        "zh-TW"
      ],
      "metadata": {
        "description": "Specify locale for Azure Billing. See https://github.com/Azure/azure-content-nlnl/blob/master/articles/billing-countries-and-currencies.md for details."
      }
    },
    "OfferDurableId": {
      "type": "string",
      "allowedValues": [
        "MS-AZR-0003P  :  Pay-As-You-Go",
        "MS-AZR-0041P  :  Support Plans",
        "MS-AZR-0042P  :  Support Plans",
        "MS-AZR-0043P  :  Support Plans",
        "MS-AZR-0044P  :  Free Trial",
        "MS-AZR-0059P  :  Visual Studio Professional subscribers",
        "MS-AZR-0060P  :  Visual Studio Test Professional subscribers",
        "MS-AZR-0062P  :  MSDN Platforms subscribers",
        "MS-AZR-0063P  :  Visual Studio Enterprise subscribers",
        "MS-AZR-0064P  :  Visual Studio Enterprise (BizSpark) subscribers",
        "MS-AZR-0029P  :  Visual Studio Enterprise (MPN) subscribers",
        "MS-AZR-0022P  :  Visual Studio Dev Essentials members",
        "MS-AZR-0023P  :  Pay-As-You-Go Dev/Test",
        "MS-AZR-0148P  :  Enterprise Dev/Test",
        "MS-AZR-0025P  :  Action Pack",
        "MS-AZR-0036P  :  Microsoft Azure Sponsored Offer",
        "MS-AZR-0120P  :  Azure Pass",
        "MS-AZR-0130P  :  Azure Pass",
        "MS-AZR-0111p  :  Azure in Open Licensing",
        "MS-AZR-0144P  :  Microsoft Imagine",
        "MS-AZR-0149P  :  BizSpark Plus",
        "MS-AZR-0145P  :  Azure in CSP",
        "MS-AZR-DE-0145P  :  Azure Germany in CSP for Microsoft Cloud Germany",
        "MS-AZR-0044P  :  Azure Germany Free Trial",
        "MS-AZR-DE-0003P  :  Azure Germany Pay-As-You-Go",
        "MS-AZR-DE-0041P  :  Azure Germany Support Plans",
        "MS-AZR-DE-0042P  :  Azure Germany Support Plans",
        "MS-AZR-DE-0043P  :  Azure Germany Support Plans",
        "MS-AZR-0051p  :  Azure Retired"
      ],
      "metadata": {
        "description": "Specify the Azure Offer ID  available in subscription details from Azure Portal"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/oms-azure-resource-usage-solution",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located"
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      }
    },
    "ingestSchedulerGuid": {
      "type": "string",
      "defaultValue": "cb466319-e0a8-42e4-b993-36dc45c0b158",
      "metadata": {
        "description": "GUID for the schedule creation - create a unique before deploy"
      }
    }
  },
  "variables": {
    "runbooks": {
      "ingestParentRunbook": {
        "name": "AzureUsage-MS-Mgmt",
        "version": "1.0.0.1",
        "description": "Runbook to automatically ingest Azure Usage data and events into OMS Log Analytics",
        "type": "PowerShell",
        "Id": ""
      },
      "ingestSchedulerRunbook": {
        "name": "AzureUsage-Schedules-MS-Mgmt",
        "version": "1.0.0.1",
        "description": "Runbook to automatically create required schedules for OMS Log Analytics ingestion",
        "type": "PowerShell",
        "Id": ""
      }
    },
    "parentRunbookUri": "[concat(parameters('_artifactsLocation'),'/scripts/AzureUsage-MS-Mgmt.ps1', parameters('_artifactsLocationSasToken'))]",
    "schedulerRunbookUri": "[concat(parameters('_artifactsLocation'),'/scripts/AzureUsage-Schedules-MS-Mgmt.ps1', parameters('_artifactsLocationSasToken'))]",
    "omsSolutions": {
      "customSolution": {
        "name": "Azure Usage",
        "solutionName": "[concat('AzureUsage', '[', parameters('omsLogAnalyticsWorkspaceName'), ']')]",
        "publisher": "volkanc@microsoft.com",
        "displayName": "Azure Usage",
        "description": "Monitor Azure Usage",
        "author": "volkanc@microsoft.com"
      }
    },
    "opsInsightWorkspaceID": "AzureUsage-OPSINSIGHTS_WS_ID",
    "opsInsightWorkspaceIDType": "string",
    "opsInsightWorkspaceIDDescription": "Value of the user's omsWorkspaceId",
    "opsInsightWorkspaceKey": "AzureUsage-OPSINSIGHT_WS_KEY",
    "opsInsightWorkspaceKeyType": "string",
    "opsInsightWorkspaceKeyDescription": "Encrypted value of the user's omsWorkspaceKey",
    "createScheduleAutomationAccountName": "AzureUsage-AzureAutomationAccount-MS-Mgmt",
    "createScheduleAutomationAccountType": "string",
    "createScheduleAutomationAccountDescription": "The name of the Automation Account",
    "createScheduleResourceGroupName": "AzureUsage-AzureAutomationResourceGroup-MS-Mgmt",
    "createScheduleResourceGroupType": "string",
    "createScheduleResourceGroupDescription": "The name of the resource group",
    "omsAutomationSku": "basic",
    "ingestInterval": "1",
    "ingestFrequency": "hour",
    "ingestScheduleName": "AzureUsage-Scheduler-",
    "propagatetags": "1"
  },
  "resources": [
    {
      "name": "[parameters('omsLogAnalyticsWorkspaceName')]",
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2015-11-01-preview",
      "location": "[parameters('omsLogAnalyticsRegion')]",
      "properties": {
        "sku": {
          "name": "[parameters('omsLogAnalyticsSku')]"
        }
      },
      "resources": [
        {
          "apiVersion": "2015-11-01-preview",
          "name": "[variables('omsSolutions').customSolution.name]",
          "type": "views",
          "id": "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('omsLogAnalyticsWorkspaceName'), variables('omsSolutions').customSolution.name)]",
          "dependson": [
            "[Concat('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]"
          ],
          "properties": {
            "Name": "[variables('omsSolutions').customSolution.name]",
            "DisplayName": "[variables('omsSolutions').customSolution.displayName]",
            "Description": "[variables('omsSolutions').customSolution.description]",
            "Author": "[variables('omsSolutions').customSolution.author]",
            "Source": "Local",
            "Dashboard": [
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VMs by Subscription",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "VM Count",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory |measure countdistinct(ID_s) by AzureSubscription_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#9b4f96",
                        "#00d8cc",
                        "#00bcf2"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory |measure countdistinct(ID_s) by AzureSubscription_s,Status_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Subscription",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VMs by Size",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Size",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory  | measure countdistinct(VmName_s) by HWProfile_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#0072c6",
                        "#fcd116",
                        "#7fba00"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory  | measure countdistinct(VmName_s) by HWProfile_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "VMSIZE",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VMs by Location",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Location",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory | measure countdistinct(VmName_s) by Location_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#55d455",
                        "#ff8c00",
                        "#eb3c00"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory | measure countdistinct(VmName_s) by Location_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Location",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VM by Deployement Type",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Classic vs ARM",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory | measure countdistinct(VmName_s) by DeploymentType_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#55d455",
                        "#ff8c00",
                        "#00bcf2"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory | measure countdistinct(ID_s) by   AzureSubscription_s,DeploymentType_s,OperatingSystem_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "VMCount",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "LineChartCalloutBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VM Status",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "",
                    "Subtitle": ""
                  },
                  "LineChart": {
                    "Query": "[concat('Type=AzureUsage_CL MetricName_s=VMInventory  | measure countdistinct(VmName_s) by Status_s interval ', parameters('omsDataIngestionFrequency'),'Minutes')]",
                    "Callout": {
                      "Title": "Running",
                      "Series": "Running",
                      "Operation": "Last Sample"
                    },
                    "yAxis": {
                      "isLogarithmic": false,
                      "units": {
                        "baseUnitType": "",
                        "baseUnit": "",
                        "displayUnit": ""
                      },
                      "customLabel": ""
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory Status_s=Running |  measure countdistinct(VmName_s)  by  HWProfile_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Size",
                      "Value": "RuningVM"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "NumberTileListBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "TAGGED VMs",
                    "newGroup": true,
                    "icon": "",
                    "useIcon": false
                  },
                  "Tile": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory |measure countdistinct(Tag_s) by AzureSubscription_s",
                    "Legend": "Tagged VM Count"
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMInventory |measure countdistinct(VmName_s) by Tag_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Computer",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VMs by Subnet",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Subnets",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNIC | measure countdistinct(VmName_s) by subnet_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00bcf2",
                        "#ffb900",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNIC | measure countdistinct(VmName_s) by AzureSubscription_s,subnet_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "ColumnsTitle": {
                      "Name": "Subscription",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "operation": "Summary",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "InputEndpoints ",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "No of VMs",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMEndpoint | measure countdistinct(VmName_s) by endpointName_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00188f",
                        "#0072c6",
                        "#00bcf2"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMEndpoint | measure countdistinct(VmName_s) by endpointName_s,privatePort_d",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "ColumnsTitle": {
                      "Name": "EndpointName",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "operation": "Summary",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "NSG Rules Applied",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "No of VMs",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNSGrule | measure countdistinct(VmName_s) by RuleName_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#fcd116",
                        "#0072c6",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNSGrule | measure countdistinct(VmName_s) by RuleName_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "ColumnsTitle": {
                      "Name": "Rule",
                      "Value": "CountVM"
                    },
                    "Color": "#0072c6",
                    "operation": "Summary",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "NSG - Allowed Ports ",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Count of Computers",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNSGrule  access_s=Allow  | measure countdistinct(VmName_s) by destinationPortRange_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00bcf2",
                        "#7fba00",
                        "#fcd116"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMNSGrule  access_s=Allow  | measure countdistinct(VmName_s) by sourcePortRange_s,destinationPortRange_s,protocol_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "ColumnsTitle": {
                      "Name": "Source",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "operation": "Summary",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Cores Utilized",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Per Region",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "[concat('Type=AzureUsage_CL MetricName_s=ARMVMUsageStats TimeGenerated>NOW-', parameters('omsDataIngestionFrequency'),'Minutes  Usagemetric_s=cores |measure max(currentValue_d) by Location_s')]",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#0072c6",
                        "#ffb900",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "[concat('Type=AzureUsage_CL MetricName_s=ARMVMUsageStats TimeGenerated>NOW-', parameters('omsDataIngestionFrequency'),'Minutes  Usagemetric_s=cores |measure max(currentValue_d) by AzureSubscription_s,Location_s')]",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "ColumnsTitle": {
                      "Name": "Subscription",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "operation": "Summary",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Disk Count by IO",
                    "newGroup": true,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "MAX DISK IO",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMDisk  | measure countdistinct(VHDUri_s) by MaxDiskIO_d",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00bcf2",
                        "#ffb900",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMDisk  | measure countdistinct(VHDUri_s) by DiskIOType_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "IOTYPE",
                      "Value": "DiskCount"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Disks by Storage Account",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMDisk | measure countdistinct(VHDUri_s) by StorageAccount_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#0072c6",
                        "#ffb900",
                        "#55d455"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMDisk | measure countdistinct(VHDUri_s) by StorageAccount_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "StorageAccount",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "VM Extensions Inventory",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Extension Count",
                    "Subtitle": ""
                  },
                  "Donut": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMExtensions | measure countdistinct(VmName_s) by Extension_s",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": []
                    },
                    "Options": {
                      "colors": [
                        "#00bcf2",
                        "#ffb900",
                        "#009e49"
                      ],
                      "valueColorMapping": []
                    }
                  },
                  "List": {
                    "Query": "Type=AzureUsage_CL MetricName_s=VMExtensions | measure countdistinct(VmName_s) by Extension_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Extension",
                      "Value": "Count"
                    },
                    "Color": "#0072c6",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "{selected item}"
                  }
                }
              }
            ],
            "OverviewTile": {
              "Id": "LineChartCalloutBuilderTile",
              "Type": "OverviewTile",
              "Version": 0,
              "Configuration": {
                "LineChart": {
                  "Query": "[concat('Type=AzureUsage_CL MetricName_s=VMInventory  | measure countdistinct(VmName_s) by Status_s interval ', parameters('omsDataIngestionFrequency'),'Minutes')]",
                  "Callout": {
                    "Title": "Running",
                    "Series": "Running",
                    "Operation": "Last Sample"
                  },
                  "yAxis": {
                    "isLogarithmic": false,
                    "units": {
                      "baseUnitType": "",
                      "baseUnit": "",
                      "displayUnit": ""
                    },
                    "customLabel": ""
                  }
                },
                "Advanced": {
                  "DataFlowVerification": {
                    "Enabled": false,
                    "Query": "*",
                    "Message": ""
                  }
                }
              }
            }

          }
        }
      ]
    },
    {
      "apiversion": "2015-10-31",
      "location": "[parameters('omsAutomationRegion')]",
      "name": "[parameters('omsAutomationAccountName')]",
      "type": "Microsoft.Automation/automationAccounts",
      "properties": {
        "sku": {
          "name": "[variables('omsAutomationSku')]"
        }
      },
      "resources": [
        {
          "name": "[variables('opsInsightWorkspaceID')]",
          "type": "variables",
          "apiVersion": "2015-10-31",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
          ],
          "tags": {},
          "properties": {
            "description": "[variables('opsInsightWorkspaceIDDescription')]",
            "isEncrypted": 0,
            "type": "[variables('opsInsightWorkspaceIDType')]",
            "value": "[concat('\"',reference(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName')), '2015-11-01-preview').customerId,'\"')]"
          }
        },
        {
          "name": "[variables('opsInsightWorkspaceKey') ]",
          "type": "variables",
          "apiVersion": "2015-10-31",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
          ],
          "tags": {},
          "properties": {
            "description": "[variables('opsInsightWorkspaceKeyDescription')]",
            "isEncrypted": 1,
            "type": "[variables('opsInsightWorkspaceKeyType')]",
            "value": "[concat('\"',listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName')), '2015-11-01-preview').primarySharedKey,'\"')]"
          }
        },
        {
          "name": "[variables('createScheduleAutomationAccountName')]",
          "type": "variables",
          "apiVersion": "2015-10-31",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
          ],
          "tags": {},
          "properties": {
            "description": "[variables('createScheduleAutomationAccountDescription')]",
            "isEncrypted": 0,
            "type": "[variables('createScheduleAutomationAccountType')]",
            "value": "[concat('\"', parameters('omsAutomationAccountName'),'\"')]"
          }
        },
        {
          "name": "[variables('createScheduleResourceGroupName')]",
          "type": "variables",
          "apiVersion": "2015-10-31",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
          ],
          "tags": {},
          "properties": {
            "description": "[variables('createScheduleResourceGroupDescription')]",
            "isEncrypted": 0,
            "type": "[variables('createScheduleResourceGroupType')]",
            "value": "[concat('\"', resourceGroup().name, '\"')]"
          }
        },
        {
          "name": "[variables('runbooks').ingestParentRunbook.name]",
          "type": "runbooks",
          "apiVersion": "2015-10-31",
          "location": "[parameters('omsAutomationRegion')]",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('opsInsightWorkspaceID'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('opsInsightWorkspaceKey'))]"
          ],
          "tags": {},
          "properties": {
            "runbookType": "[variables('runbooks').ingestParentRunbook.type]",
            "logProgress": "false",
            "logVerbose": "false",
            "description": "[variables('runbooks').ingestParentRunbook.description]",
            "publishContentLink": {
              "uri": "[variables('parentRunbookUri')]",
              "version": "[variables('runbooks').ingestParentRunbook.version]"
            }
          }
        },
        {
          "name": "[variables('runbooks').ingestSchedulerRunbook.name]",
          "type": "runbooks",
          "apiVersion": "2015-10-31",
          "location": "[parameters('omsAutomationRegion')]",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('opsInsightWorkspaceID'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('opsInsightWorkspaceKey'))]"
          ],
          "tags": {},
          "properties": {
            "runbookType": "[variables('runbooks').ingestSchedulerRunbook.type]",
            "logProgress": "false",
            "logVerbose": "false",
            "description": "[variables('runbooks').ingestSchedulerRunbook.description]",
            "publishContentLink": {
              "uri": "[variables('schedulerRunbookUri')]",
              "version": "[variables('runbooks').ingestSchedulerRunbook.version]"
            }
          }
        },
        {
          "name": "[concat(parameters('omsAutomationAccountName'), '/', variables('ingestscheduleName'),parameters('omsDataIngestionFrequency'),'-',parameters('ingestSchedulerGuid'))]",
          "type": "microsoft.automation/automationAccounts/schedules",
          "apiVersion": "2015-10-31",
          "location": "[parameters('omsAutomationRegion')]",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestSchedulerRunbook.name)]"
          ],
          "tags": {},
          "properties": {
            "description": "OMS Ingestion API Scheduler",
            "startTime": "",
            "isEnabled": "true",
            "interval": "[variables('ingestInterval')]",
            "frequency": "[variables('ingestFrequency')]"
          }
        },
        {
          "name": "[concat(parameters('omsAutomationAccountName'), '/', parameters('ingestSchedulerGuid'))]",
          "type": "microsoft.automation/automationAccounts/jobSchedules",
          "apiVersion": "2015-10-31",
          "location": "[parameters('omsAutomationRegion')]",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/schedules/', variables('ingestscheduleName'),parameters('omsDataIngestionFrequency'),'-',parameters('ingestSchedulerGuid'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestSchedulerRunbook.name)]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
          ],
          "tags": {},
          "properties": {
            "schedule": {
              "name": "[concat(variables('ingestscheduleName'),parameters('omsDataIngestionFrequency'),'-',parameters('ingestSchedulerGuid'))]"
            },
            "runbook": {
              "name": "[variables('Runbooks').ingestSchedulerRunbook.name]"
            }
          }
        },
        {
          "name": "[concat(parameters('omsAutomationAccountName'), '/', parameters('ingestSchedulerGuid'))]",
          "type": "Microsoft.Automation/automationAccounts/jobs",
          "apiVersion": "2015-10-31",
          "location": "[parameters('omsAutomationRegion')]",
          "dependsOn": [
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestSchedulerRunbook.name)]",
            "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestParentRunbook.name)]"

          ],
          "tags": {},
          "properties": {
            "runbook": {
              "name": "[variables('runbooks').ingestSchedulerRunbook.name]"
            },
            "parameters": {
              "Currency": "[parameters('Currency')]",
              "Locale": "[parameters('Locale')]",
              "RegionInfo": "[parameters('RegionInfo')]",
              "OfferDurableId": "[parameters('OfferDurableId')]",
              "propagatetags": "[variables('propagatetags')]",
              "syncInterval": "[parameters('omsDataIngestionFrequency')]",
              "clearLocks": "1"
            }
          }
        }
      ]
    },
    {
      "name": "[variables('omsSolutions').customSolution.solutionName]",
      "type": "Microsoft.OperationsManagement/solutions",
      "apiVersion": "2015-11-01-preview",
      "location": "[parameters('omsLogAnalyticsRegion')]",
      "dependsOn": [
        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]",
        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'), '/views/', variables('omsSolutions').customSolution.name)]",
        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestSchedulerRunbook.name)]",
        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('runbooks').ingestParentRunbook.name)]"

      ],
      "plan": {
        "name": "[variables('omsSolutions').customSolution.solutionName]",
        "product": "[variables('omsSolutions').customSolution.name]",
        "publisher": "[variables('omsSolutions').customSolution.publisher]",
        "promotionCode": ""
      },
      "properties": {
        "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsLogAnalyticsWorkspaceName'))]",
        "referencedResources": [],
        "containedResources": [
          "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('omsLogAnalyticsWorkspaceName'), variables('omsSolutions').customSolution.name)]",
          "[resourceId('Microsoft.Automation/automationAccounts/runbooks/', parameters('omsAutomationAccountName'), variables('runbooks').ingestSchedulerRunbook.name)]",
          "[resourceId('Microsoft.Automation/automationAccounts/runbooks/', parameters('omsAutomationAccountName'), variables('runbooks').ingestParentRunbook.name)]"
        ]
      }
    }
  ],
  "outputs": {}
}